# FastAPI MCP Server 技术文档

## 项目概述

本项目是一个基于 FastAPI 的 Model Context Protocol (MCP) 服务器，提供了 Excel 和 CSV 数据处理、每日语录等工具服务的 RESTful API 接口。该服务器支持会话管理、工具注册与调用，以及多种数据处理功能。

## 项目结构

```
src/
├── main.py                 # FastAPI 应用主入口
├── core/                   # 核心模块
│   ├── __init__.py
│   ├── config.py          # 配置管理
│   └── mcp.py             # MCP 协议处理器
└── services/               # 服务模块
    ├── __init__.py
    ├── csv_tool.py        # CSV 数据处理服务
    ├── excel_tool.py      # Excel 数据处理服务
    └── daily_quote.py     # 每日语录服务
```

## 核心模块详解

### 1. 配置管理 (core/config.py)

**功能**: 使用 Pydantic Settings 管理应用配置

**主要配置项**:
- `PROJECT_NAME`: 项目名称，默认 "FASTAPI MCP Server"
- `API_PREFIX`: API 路径前缀，默认 "/api"
- `DEBUG`: 调试模式开关
- `EXCEL_FILES_DIR`: Excel 文件存储目录，默认 "./data/excel"
- `CSV_FILES_DIR`: CSV 文件存储目录，默认 "./data/csv"
- `ALLOWD_TOOLS`: 允许使用的工具列表
- `DEEPSEEK_API_KEY`: DeepSeek API 密钥（可选）
- `N8N_INTEGRATION_ENABLED`: n8n 集成开关

**使用方式**:
```python
from src.core.config import settings

# 访问配置
data_dir = settings.CSV_FILES_DIR
```

### 2. MCP 协议处理器 (core/mcp.py)

#### 2.1 ToolDefinition 类

**功能**: 定义工具的基本结构和执行逻辑

**主要方法**:
- `execute(**kwargs)`: 执行工具函数，支持同步和异步函数，支持 Pydantic 参数验证
- `to_dict()`: 将工具定义转换为字典格式

**特性**:
- 自动检测并处理异步函数
- 支持 Pydantic 模型的参数验证
- 错误处理和异常捕获

#### 2.2 MCPSession 类

**功能**: 管理 MCP 会话

**属性**:
- `session_id`: 会话唯一标识符（UUID）
- `auth_key`: 认证密钥（UUID）
- `supported_tools`: 该会话支持的工具列表
- `connected`: 连接状态

**主要方法**:
- `verify_auth(auth_key: str)`: 验证认证密钥
- `disconnect()`: 断开连接
- `to_dict()`: 转换为字典格式

#### 2.3 MCPMessage 类

**功能**: Pydantic 模型，定义 MCP 消息结构

**字段**:
- `message_id`: 消息ID（自动生成）
- `tool_name`: 工具名称
- `arguments`: 工具参数字典
- `authentication_key`: 认证密钥（可选）
- `error`: 错误信息（可选）
- `result`: 执行结果（可选）

#### 2.4 MCPHandler 类

**功能**: MCP 消息处理器，管理工具注册和消息处理

**主要方法**:
- `create_session() -> MCPSession`: 创建新会话
- `get_session(session_id: str) -> Optional[MCPSession]`: 获取会话
- `register_tool(tool_name, tool_func, description, params_schema, force)`: 注册工具
- `get_tool_definitions() -> Dict`: 获取所有工具定义
- `process_message(message: MCPMessage, session_id: str) -> MCPMessage`: 处理消息

**全局实例**: `mcp_handler` - 在模块级别创建的单例实例

### 3. 主应用入口 (main.py)

**框架**: FastAPI

**主要功能**:
1. 初始化 FastAPI 应用
2. 注册 CORS 中间件
3. 注册所有工具到 MCP Handler
4. 提供 RESTful API 接口

#### 3.1 API 端点

##### GET `/`
**功能**: 根路径，返回服务状态

**响应**:
```json
{
  "stauts": "online",
  "service": "FASTAPI MCP Server",
  "version": "1.0.0",
  "api_prefix": "/api"
}
```

##### GET `/api/mcp/tools`
**功能**: 获取所有可用工具列表

**响应**:
```json
{
  "tools": ["csv_list", "csv_read", ...],
  "definitions": {
    "csv_list": {
      "name": "csv_list",
      "description": "列出可用的CSV文件",
      "parameters": {}
    },
    ...
  }
}
```

##### POST `/api/mcp/init`
**功能**: 初始化 MCP 会话

**响应模型**: `MCPInitResponse`

**响应**:
```json
{
  "session_id": "uuid",
  "auth_key": "uuid",
  "supported_tools": ["csv_list", ...],
  "tool_definitions": {...}
}
```

##### POST `/api/mcp/session/{session_id}/message`
**功能**: 处理 MCP 消息，调用工具

**请求体**: `MCPMessageRequest`
```json
{
  "message_id": "optional-uuid",
  "tool_name": "csv_read",
  "arguments": {"file_path": "data.csv"},
  "authentication_key": "auth-key"
}
```

**响应模型**: `MCPMessageResponse`
```json
{
  "message_id": "uuid",
  "tool_name": "csv_read",
  "result": {...}
}
```

##### DELETE `/api/mcp/session/{session_id}`
**功能**: 断开会话连接

**响应**:
```json
{
  "message": "会话 {session_id} 已断开连接"
}
```

## 服务模块详解

### 1. CSV 工具服务 (services/csv_tool.py)

#### 1.1 csv_list()
**功能**: 列出 data/csv 目录下所有 CSV 文件

**返回**:
```json
{
  "files": ["file1.csv", "subdir/file2.csv"]
}
```

#### 1.2 csv_read(file_path, delimiter, encoding)
**功能**: 读取 CSV 文件内容

**参数**:
- `file_path`: CSV 文件路径（相对于 data/csv 目录）
- `delimiter`: 分隔符，默认 ","
- `encoding`: 编码格式，默认 "utf-8"

**返回**:
```json
{
  "stats": {
    "row_count": 100,
    "column_count": 5,
    "columns": ["col1", "col2", ...],
    "sample_rows": [...]
  },
  "data": [...],  // 前100行数据
  "truncated": false
}
```

#### 1.3 csv_visualize(file_path, x_column, y_column, chart_type, title)
**功能**: 基于 CSV 数据创建可视化图表

**参数**:
- `file_path`: CSV 文件路径
- `x_column`: X 轴列名
- `y_column`: Y 轴列名
- `chart_type`: 图表类型（bar, line, scatter, pie）
- `title`: 图表标题

**返回**:
```json
{
  "chart_type": "bar",
  "title": "数据可视化",
  "image_base64": "base64编码的图片字符串"
}
```

**注意事项**: 
- 使用 matplotlib 生成图表
- 图表以 PNG 格式编码为 Base64 返回

#### 1.4 csv_aggregate(file_path, group_by, agg_column, agg_func)
**功能**: 对 CSV 数据进行聚合操作

**参数**:
- `file_path`: CSV 文件路径
- `group_by`: 分组列名
- `agg_column`: 聚合列名
- `agg_func`: 聚合函数（sum, mean, max, min, count）

**返回**:
```json
{
  "aggregation": [
    {"group_by_value": "A", "agg_column": 100},
    ...
  ],
  "group_by": "category",
  "agg_column": "sales",
  "agg_func": "sum"
}
```

### 2. Excel 工具服务 (services/excel_tool.py)

#### 2.1 excel_list()
**功能**: 列出 data/excel 目录下所有 Excel 文件

**返回**:
```json
{
  "files": ["file1.xlsx", "file2.xlsx"]
}
```

#### 2.2 excel_read(file_name, sheet_name)
**功能**: 读取 Excel 文件内容

**参数**:
- `file_name`: Excel 文件名
- `sheet_name`: 工作表名称（可选，默认第一个工作表）

**返回**:
```json
{
  "file_name": "data.xlsx",
  "sheet_name": "Sheet1",
  "columns": ["col1", "col2", ...],
  "rows": [...],
  "row_count": 100
}
```

#### 2.3 excel_info(file_name)
**功能**: 获取 Excel 文件详细信息

**参数**:
- `file_name`: Excel 文件名

**返回**:
```json
{
  "file_name": "data.xlsx",
  "sheets": [
    {
      "name": "Sheet1",
      "rows": 100,
      "columns": 5,
      "column_names": ["col1", ...]
    },
    ...
  ],
  "sheet_count": 2,
  "file_size_kb": 123.45
}
```

### 3. 每日语录服务 (services/daily_quote.py)

#### 3.1 get_daily_quote()
**功能**: 获取每日鸡汤语录（同一天返回相同内容）

**实现原理**: 使用日期作为随机种子，确保同一天返回固定内容

**返回**:
```json
{
  "date": "2024-01-15",
  "quote": "今天又是美好的一天，加油！",
  "category": "inspiration"
}
```

#### 3.2 get_random_quote(category)
**功能**: 获取随机鸡汤语录

**参数**:
- `category`: 分类（可选，当前仅支持 "inspiration"）

**返回**:
```json
{
  "quote": "不要放弃，坚持就是胜利！",
  "category": "inspiration"
}
```

## 已注册的工具列表

在 `main.py` 中注册了以下工具：

1. `csv_list` - 列出可用的CSV文件
2. `csv_read` - 读取CSV文件内容
3. `csv_aggregate` - 对CSV数据进行聚合操作
4. `csv_visualize` - 可视化CSV数据
5. `excel_list` - 列出可用的Excel文件
6. `excel_read` - 读取Excel文件内容
7. `excel_info` - 获取Excel文件信息
8. `random_quote` - 获取随机鸡汤
9. `daily_quote` - 获取每日鸡汤

## 使用流程

### 1. 启动服务

```bash
python src/main.py
```

服务将在 `http://127.0.0.1:8000` 启动

### 2. 初始化会话

```bash
curl -X POST http://127.0.0.1:8000/api/mcp/init
```

响应中包含 `session_id` 和 `auth_key`

### 3. 调用工具

```bash
curl -X POST http://127.0.0.1:8000/api/mcp/session/{session_id}/message \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "csv_list",
    "arguments": {},
    "authentication_key": "your-auth-key"
  }'
```

### 4. 断开会话

```bash
curl -X DELETE http://127.0.0.1:8000/api/mcp/session/{session_id}
```

## 技术栈

- **FastAPI**: 现代、快速的 Web 框架
- **Pydantic**: 数据验证和设置管理
- **Pandas**: 数据处理和分析
- **Matplotlib**: 数据可视化
- **Uvicorn**: ASGI 服务器

## 依赖关系

项目依赖以下 Python 包：
- `fastapi`
- `pydantic`
- `pydantic-settings`
- `pandas`
- `matplotlib`
- `openpyxl` (用于读取 Excel 文件)
- `uvicorn`

## 数据目录结构

项目使用以下目录结构存储数据文件：

```
data/
├── csv/          # CSV 文件存储目录
└── excel/        # Excel 文件存储目录
```

这些目录会在首次使用时自动创建。

## 代码问题与注意事项

### 1. main.py 中的问题

- **第34行**: `mcp_handler` 在使用前未定义，需要从 `core.mcp` 导入
- **第92行**: 缺少逗号
- **第100行**: 缺少逗号
- **第105行**: 多余的句号
- **第108行**: 缺少冒号
- **第123行**: `MCPMessageReques` 应为 `MCPMessageRequest`

### 2. csv_tool.py 中的问题

- **第6行**: `mapplotlib.pyplot` 应为 `matplotlib.pyplot`
- **第18行**: `dilimiter` 应为 `delimiter`
- **第104行**: 语法错误，应为 `f"可视化失败: {str(e)}"`

### 3. mcp.py 中的问题

- **第43行**: `RuntimeError:o` 应为 `RuntimeError:`
- **第150行**: `不适` 应为 `不是`

## 扩展开发指南

### 添加新工具

1. 在 `services/` 目录下创建新的服务文件或扩展现有文件
2. 实现工具函数（支持同步和异步）
3. 在 `main.py` 中注册工具：

```python
mcp_handler.register_tool(
    "tool_name",
    tool_function,
    "工具描述"
)
```

### 添加参数验证

使用 Pydantic 模型定义参数：

```python
from pydantic import BaseModel

class ToolParams(BaseModel):
    param1: str
    param2: int = 10

mcp_handler.register_tool(
    "tool_name",
    tool_function,
    "工具描述",
    params_schema=ToolParams
)
```

## API 文档

启动服务后，可以访问以下地址查看自动生成的 API 文档：

- Swagger UI: `http://127.0.0.1:8000/docs`
- ReDoc: `http://127.0.0.1:8000/redoc`

## 安全建议

1. **认证**: 当前使用简单的 UUID 认证密钥，生产环境应使用更安全的认证机制
2. **CORS**: 当前允许所有来源（`allow_origins=["*"]`），生产环境应限制允许的域名
3. **文件路径**: 应验证文件路径，防止目录遍历攻击
4. **文件大小**: 应考虑限制读取的文件大小，防止内存溢出

## 许可证

（待补充）

## 更新日志

（待补充）

